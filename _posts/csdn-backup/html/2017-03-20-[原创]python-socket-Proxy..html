---
layout: post
title: "[原创]python-socket-Proxy."
date: 2017-03-20 14:48:33
image: '/assets/img/'
description: ""
tags:
    - 
categories:
    - python
---



<div id="sina_keyword_ad_area2" class="articalContent newfont_family">python基于socket的代理<br /><div><a href="http://https//pypi.python.org/pypi/SocksiPy">SocksiPy</a>--- https://pypi.python.org/pypi/SocksiPy</div><div><a href="https://pypi.python.org/pypi/SocksiPy-branch">SocksiPy-branch</a> - version:1.01 --- https://pypi.python.org/pypi/SocksiPy-branch</div><div><br /></div><div>用法：</div><div><div>print "----------- socket proxy ----------"</div><div>import socks</div><div>import socket</div><div>base_socket = socket.socket</div><div><br /></div><div>import requests as req</div><div>import urllib</div><div><br /></div><div>print "\n-------------not set proxy--------------"</div><div>printurllib.urlopen("http://1111.ip138.com/ic.asp").read()</div><div><br /></div><div>print "\n--------------set proxy------------------"</div><div>socks.setdefaultproxy(socks.PROXY_TYPE_SOCKS5,"10.10.20.125",443)</div><div>socket.socket = socks.socksocket</div><div>printurllib.urlopen("http://1111.ip138.com/ic.asp").read()</div><div><br /></div><div>print '\n--------------cancel proxy----------------'</div><div>socket.socket = base_socket</div><div>printurllib.urlopen("http://1111.ip138.com/ic.asp").read()</div><div><br /></div><div>print '\n--------------reset socketproxy-----------------'</div><div>socket.socket = socks.socksocket</div><div>print req.get("http://1111.ip138.com/ic.asp").content</div><div><br /></div><div>print '\n--------------recancel proxy----------------'</div><div>socket.socket.setproxy()</div><div>print req.get("http://1111.ip138.com/ic.asp").content</div></div><div><br /></div><div><br /></div><div>通过输出，可以发现是可以用的</div><div>这是源示例，还有别人改造过的代码是<a href="https://github.com/sqlmapproject/sqlmap">sqlmap</a>的代码，<a href="https://github.com/sqlmapproject/sqlmap/blob/c34eaa1ce88375085ef7d645cdc6b43b6ae5245c/thirdparty/socks/socks.py">thirdparty/socks/socks.py</a></div><div>里面是加了几个函数的，<span style="color:rgb(121,93,163);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">wrapmodule、</span><span style="color:rgb(121,93,163);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">unwrapmodule、</span><span style="color:rgb(121,93,163);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">create_connection</span><span style="line-height:21px;">，</span><span style="line-height:21px;">用的其他的我没事细看，没多做diff看改动过哪里。</span></div><div><span style="line-height:21px;">用法呢，可以看</span><a href="https://github.com/sqlmapproject/sqlmap">sqlmap</a><span style="line-height:21px;">的代码：</span><a href="https://github.com/sqlmapproject/sqlmap/blob/c34eaa1ce88375085ef7d645cdc6b43b6ae5245c/lib/core/option.py">lib/core/option.py</a></div><div><span style="color:rgb(167,29,93);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">if</span> <span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">scheme</span> <span style="color:rgb(167,29,93);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">in</span> <span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">(</span><span style="color:rgb(0,134,179);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">PROXY_TYPE</span><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">.</span><span style="color:rgb(0,134,179);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">SOCKS4</span><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">,</span><span style="color:rgb(0,134,179);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">PROXY_TYPE</span><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">.</span><span style="color:rgb(0,134,179);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">SOCKS5</span><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">):</span></div><div><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">    socks.setdefaultproxy(socks.</span><span style="color:rgb(0,134,179);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">PROXY_TYPE_SOCKS5 </span><span style="color:rgb(167,29,93);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">if</span> <span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">scheme</span><span style="line-height:16.8px;background-color:rgb(255,255,255);"> </span><span style="color:rgb(167,29,93);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">==</span> <span style="color:rgb(0,134,179);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">PROXY_TYPE</span><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">.</span><span style="color:rgb(0,134,179);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">SOCKS5 </span><span style="color:rgb(167,29,93);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">else</span> <span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">socks.</span><span style="color:rgb(0,134,179);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">PROXY_TYPE_SOCKS4</span><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">, \</span></div><div><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">        hostname, port, </span><span style="color:rgb(237,106,67);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">username</span><span style="color:rgb(167,29,93);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">=</span><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">username, </span><span style="color:rgb(237,106,67);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">password</span><span style="color:rgb(167,29,93);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">=</span><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">password)</span></div><div><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">    s</span><span style="background-color:rgb(255,255,255);color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;">ocks.wrapmodule(urllib2)</span></div><div><span style="color:rgb(167,29,93);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">else</span><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">:</span></div><div><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">    socks.unwrapmodule(urllib2)</span></div><div><span style="line-height:21px;">看过sqlmap的socks.py就可以理解，</span><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">wrapmodule其实就对对某个模块的socket代码进行备份、替换为socket代理模式。</span></div><div><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">怎么说呢，推荐使用sqlmap改造的socks.py</span></div><div><span style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;color:#333333;"><span style="font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);"><br /></span></span></div><div><span style="font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;color:#333333;"><span style="font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);">TODO：缺点：项目全局的socket代理，感觉不是太好，得稍微改造一下，让其支持多线程、多socket代理。</span></span></div><div><span style="color:rgb(51,51,51);font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace;font-size:12px;line-height:16.8px;background-color:rgb(255,255,255);"><br /></span></div></div>