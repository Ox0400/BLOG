---
layout: post
title: "[原创]python-DNS-缓存-配置"
date: 2017-03-20 14:48:30
image: '/assets/img/'
description: ""
tags:
    - 
categories:
    - python
---



<div id="sina_keyword_ad_area2" class="articalContent newfont_family"><span style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">做广域网分布式爬虫，网络状态不一致，经常连接错误、超时、连接未找到、域名没找到等的吧，DNS缓存就起作用了。</span><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">最直接的做法，<span style="color:#FF0000;line-height:21px;">可以直接设置/etc/hosts</span>，但这个是设置全局的。也可以在程序中控制。</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">其实就是<span style="color:#FF0000;line-height:21px;">在http绑定socket address前，socket根据域名获取ip这块返回指定的ip</span>即可。</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">从开源代码<a href="https://github.com/sqlmapproject/sqlmap" style="color:rgb(129,151,176);">sqlmap</a>中<a href="https://github.com/sqlmapproject/sqlmap/blob/c34eaa1ce88375085ef7d645cdc6b43b6ae5245c/lib/core/option.py" style="color:rgb(129,151,176);">lib/core/option.py</a> 中扒一块代码出来：</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><div>def _setDNSCache():</div><div>    """</div><div>    Makes a cached version of socket._getaddrinfo to avoid subsequent DNS requests.</div><div>    """</div><div><br /></div><div>    def _getaddrinfo(*args, **kwargs):</div><div>        if args in kb.cache:</div><div>            return kb.cache[args]</div><div><br /></div><div>        else:</div><div>            kb.cache[args] = socket._getaddrinfo(*args, **kwargs)</div><div>            return kb.cache[args]</div><div><br /></div><div>    if not hasattr(socket, "_getaddrinfo"):</div><div>        socket._getaddrinfo = socket.getaddrinfo</div><div>        socket.getaddrinfo = _getaddrinfo</div></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">要把功能改造，然后植入自己的项目中，</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">项目本身的需求是保存在本地dns配置，从本地dns配置读取，还需要提的是，dns缓存选dns服务器也很重要的.</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">改造后如下：</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><div>####################################################################</div><div># -*- coding:utf-8 -*-</div><div><br /></div><div># @version: 1.0</div><div># @author: ZhangZhipeng</div><div># @date: 2015-12-01</div><div><br /></div><div># source: sqlmap/lib/core/option.py line_no: 1105</div><div># https://github.com/sqlmapproject/sqlmap</div><div><br /></div><div>import socket</div><div>from dns.resolver import Resolver</div><div>from dns.exception import DNSException</div><div><br /></div><div><br /></div><div>resolver = Resolver()</div><div><br /></div><div>_dnscache = {}</div><div>dns_name_servers = [</div><div>    '114.114.114.114',</div><div>    '223.5.5.5',</div><div>    '223.6.6.6',</div><div>    '8.8.8.8',</div><div>]</div><div><br /></div><div>resolver.nameservers = list(set(dns_name_servers + resolver.nameservers))</div><div>print "dns servers:", resolver.nameservers</div><div><br /></div><div><br /></div><div>def start_dns_cache(file_name=None):</div><div>    load_hosts_dns_setting(file_name)</div><div>    set_socket_getaddrinfo(file_name)</div><div>    dump_hosts_dns_setting(file_name)</div><div><br /></div><div><br /></div><div>def load_hosts_dns_setting(file_name):</div><div>    if not file_name:</div><div>        return</div><div>    global _dnscache</div><div>    try:</div><div>        with file(file_name)as f:</div><div>            lines = f.read().splitlines()</div><div>            for i in lines:</div><div>                line = i.strip()</div><div>                ip_host = i.split(" ")</div><div>                if len(ip_host) != 2:</div><div>                    continue</div><div>                ip, host = ip_host</div><div>                addrinfo = (2, 1, 0, '', (ip, 80))</div><div>                _dnscache.setdefault((host, 80, 0, 1), [])</div><div>                _dnscache[(host, 80, 0, 1)].append(addrinfo)</div><div>    except:</div><div>        pass</div><div><br /></div><div><br /></div><div>def dump_hosts_dns_setting(file_name):</div><div>    if not file_name:</div><div>        return</div><div>    dns_list = set([])</div><div>    for hostinfo, addrinfo_list in _dnscache.items():</div><div>        host = hostinfo[0]</div><div>        for addrinfo in addrinfo_list:</div><div>            ip = addrinfo[-1][0]</div><div>            dns_list.add(ip + " " + host + "\n")</div><div>    with file(file_name, "w")as f:</div><div>        f.write("".join(dns_list))</div><div><br /></div><div><br /></div><div>def set_socket_getaddrinfo(file_name=None):</div><div>    def _getaddrinfo(*args, **kwargs):</div><div>        # print</div><div>        global _dnscache</div><div>        if args in _dnscache:</div><div>            # print args, " in cache", _dnscache[args]</div><div>            return _dnscache[args]</div><div>        else:</div><div>            _dnscache.setdefault(args, [])</div><div>            # print args, "not in cache"</div><div>            addrinfo_list = get_addrinfo(*args[:1])</div><div>            if not addrinfo_list:</div><div>                _dnscache[args] = socket._getaddrinfo(*args, **kwargs)</div><div>                return _dnscache[args]</div><div>            for i in addrinfo_list:</div><div>                addrinfo = (2, 1, 0, '', (i, args[1]))</div><div>                # print args, "add address:", addrinfo</div><div>                _dnscache[args].append(addrinfo)</div><div>            if file_name:</div><div>                with file(file_name, "a")as f:</div><div>                    dns_setting = i + " " + args[0] + "\n"</div><div>                    f.write(dns_setting)</div><div>            return _dnscache[args]</div><div><br /></div><div>    if not hasattr(socket, '_getaddrinfo'):</div><div>        socket._getaddrinfo = socket.getaddrinfo</div><div>        socket.getaddrinfo = _getaddrinfo</div><div><br /></div><div><br /></div><div>def get_addrinfo(host):</div><div>    try:</div><div>        return [host.to_text() for host in resolver.query(host)]</div><div>    except DNSException, e:</div><div>        return []</div><div><br /></div><div>###############test<span style="line-height:21px;">###############</span></div><div>def test():</div><div>    set_socket_getaddrinfo()</div><div>    import urllib</div><div>    import requests</div><div>    urllib.urlopen('http://baidu.com')</div><div>    requests.get("http://baidu.com")</div><div>    urllib.urlopen('http://10.20.12.10:26680/client/weibo')</div><div><br /></div><div><br /></div><div>def test_get_addr(hosts=None):</div><div>    if type(hosts) in (tuple, list):</div><div>        for i in hosts:</div><div>            if not i:</div><div>                continue</div><div>            # print i</div><div>            for addrinfo in get_addrinfo(i):</div><div>                print addrinfo, i</div><div><br /></div><div><br /></div><div>if __name__ == '__main__':</div><div>    test()</div><div><br /></div><div>    hosts = """</div><div>    api.weibo.com</div><div>    beacon.sina.com.cn</div><div>    login.sina.com.cn</div><div>    login.weibo.cn</div><div>    passport.weibo.com</div><div>    rs.sinajs.cn</div><div>    s.weibo.com</div><div>    weibo.com</div><div>    www.weibo.com</div><div>    """</div><div>    hosts = hosts.replace(" ", "").splitlines()</div><div>    test_get_addr(hosts)</div><div>    start_dns_cache("dns-test.hosts")</div></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">####################################################################</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">## 这个呢，是直接写入到一个文件中了，可以直接用序列化来管理</span><span style="line-height:21px;">_dnscache，这样就只需要load、update、dump就可以了，但是这样子配置文件就无法直视了，并不是很不方便，有点不可取...</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;"><br /></span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">优点：</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">只针对当前程序生效</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">可配置DNS服务器（硬编码）</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">自主配置DNS-HOST配置文件</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">可以DNS配置持久化（可选）</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;"><br /></span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">缺点：</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">不对系统全局生效，可以指定file_name=/etc/hosts #慎重</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">会对所有的访问域名做dns缓冲，可以加个参数只对dns-host配置中的存在的域名做缓冲、持久化，或者另写一个配置文件，管理针对哪些域名做dns缓冲、持久化。</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">没有做读写锁，如果是多线程，不安全</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">每次获取到新的dns直接写入文件，如果是大型的爬虫，网站N多，可能会导致I/O居高，可以做缓冲区设置，多少域名后再做持久化，或者根据时间戳做持久化。</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">写文件本身不安全，可以用nosql或sql等数据库做管理。sqllite、redis、mysql等</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;"><br /></span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">参考：</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">《<a href="http://www.programcreek.com/python/example/74095/socket._getaddrinfo" style="color:rgb(129,151,176);">Python socket._getaddrinfo Examples</a>》</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">《<a href="https://github.com/sqlmapproject/sqlmap" style="color:rgb(129,151,176);">sqlmapproject/sqlmap/ib/core/option.py</a>》</div><div><br /></div><div><br /></div></div>