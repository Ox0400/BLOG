---
layout: post
title: "[原创]python-urllib2-httplib-源码"
date: 2017-03-20 14:48:16
image: '/assets/img/'
description: ""
tags:
    - python
    - urllib
categories:
    - python
---



<div id="sina_keyword_ad_area2" class="articalContent newfont_family"><div></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">#看过源码的感觉就是，urllib2重构了很多层代码。。很多我们用不到。。。</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">#</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">#</div><span style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">在微博上闲逛，然后看到知道余弦大神说“知道创于研发技能表v3.0”马上就要面世，所以去官网找了找，没找到。。</span><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">所以还是看了看<span style="line-height:21px;">《</span><a href="http://blog.knownsec.com/Knownsec_RD_Checklist/v2.2.html" style="color:rgb(129,151,176);">知道创于研发技能表v2.2</a><span style="line-height:21px;">》 其中有一行，我发现我没看到过，可见之前看的不仔细。。。</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><ul style="border:0px;list-style:none;font-family:sans-serif;font-size:14px;line-height:normal;"><li style="margin-left:30px;border:0px;list-style:square url(&quot;http://blog.knownsec.com/knownsec_rd_checklist/v2.2.html_files/minus.png&quot;);"><div>Python</div><ul style="border:0px;list-style:none;"><li style="margin-left:30px;border:0px;list-style:square url(&quot;http://blog.knownsec.com/knownsec_rd_checklist/v2.2.html_files/minus.png&quot;);"><div>urllib2</div><ul style="border:0px;list-style:none;"><li style="margin-left:30px;border:0px;list-style:square url(&quot;http://blog.knownsec.com/knownsec_rd_checklist/v2.2.html_files/minus.png&quot;);"><div>打开请求响应调试</div><ul style="border:0px;list-style:none;"><li style="margin-left:30px;border:0px;list-style:square;"><div>编辑urllib2的do_open里的h.set_debuglevel</div></li><li style="margin-left:30px;border:0px;list-style:square;"><div>改为h.set_debuglevel(1)，这时可以清晰看到请求响应数据，包括https</div></li></ul></li></ul></li></ul></li></ul></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">我觉得吧，直接改源码是办法，但直接改函数内部代码也不是办法，所以就看了一下urllib2源码</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="color:#05FF2B;line-height:21px;">其实可以考虑把<strong>AbstractHTTPHandler.__init__(self, debuglevel=0)</strong>默认值为1。 原因是防坑。。。</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">    如果urllib2引入后没有使用过，会创建全局变量_opener</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">    global _opener</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">    如果存在_opener，则用_opener.open(url, data, timeout)</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">    _opener 可以由build_opener()构建，返回类<strong>OpenerDirector</strong>的实例.</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">        <strong>default_classes</strong>默认有<span style="line-height:1.5;">[ProxyHandler, UnknownHandler, HTTPHandler, HTTPDefaultErrorHandler, HTTPRedirectHandler, FTPHandler, FileHandler, HTTPErrorProcessor]</span>几个类</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">        如果<strong>hasattr(httplib, 'HTTPS')</strong>则追加<strong>HTTPSHandler</strong>类至<strong>default_classes</strong></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">        <strong>HTTPHandler</strong>和<strong>HTTPSHandler</strong>继承自<span style="line-height:21px;"><strong>AbstractHTTPHandler</strong>，可以设定调试级别</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;"><br /></span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">       将</span><strong>default_classes</strong><span style="line-height:21px;">所有的Handlers，依次实例，调用</span><span style="line-height:1.5;">OpenerDirector.add_handler(handler)</span><span style="line-height:21px;">添加到opener中。</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">        </span><span style="line-height:1.5;">OpenerDirector.add_handler(handler)</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><strong>            dir()</strong>获取<strong>handler</strong>所有的属性<strong>，</strong>忽略<strong>["redirect_request", "do_open", "proxy_open"]</strong></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><strong>           </strong> 根据_下划线分割为(<strong>请求类型 </strong>/ <strong><em>操作</em></strong>) Ex: http_error, http_request, http_response, http_open</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">            依次添加到<span style="line-height:1.5;">OpenerDirector.handle_open</span>(字典格式，key值有http, https, ftp, file等，value是一个列表，存放多个handler)</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">            疑问，不知道为什么要用bisect.insort添加至列表。作用仅仅是排序....</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;"><br /></span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">    urllib2.urlopen就是调用<strong>_opener.</strong></span><strong>open(self, fullurl, data=None, timeout=socket._GLOBAL_DEFAULT_TIMEOUT)</strong></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">        创建<strong>Request(fullurl, data)</strong>对象 (fullurl可以是url，或者是Request实例)</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">        <strong><span style="line-height:21px;">Request.</span>get_type()</strong> 是根据url返回http/https等请求类型，赋值给<strong>protocol</strong></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><div>        </div><div>        # 处理request，获取response</div><div>        获取<span style="line-height:1.5;">OpenerDirector.handle_open</span><span style="line-height:1.5;">中</span>http的类列表(handlers)，依次执行<strong>handler.http_request(request)</strong>获取<strong>request</strong>.(其实列表里面只有一个handler)</div><div>        </div><div>        <span style="line-height:1.5;">OpenerDirector._open(req, data=None)</span></div><div><strong>            OpenerDirector._call_chain(chain, kind, meth_name, *args) chain</strong>就是指<span style="line-height:1.5;">OpenerDirector.handle_open</span>字典，<strong>kind</strong>指请求类型：<strong>http/https</strong>等，<strong>method</strong>就是要执行的操作</div><div>            尝试获取<span style="line-height:1.5;">OpenerDirector._call_chain(...): OpenerDirector.handle_open.get("default", [])，循环执行handles</span>依次执行函数<span style="line-height:1.5;">default_open，</span><span style="line-height:1.5;">并返回</span><span style="line-height:1.5;">response</span></div><div><span style="line-height:21px;">       </span><span style="line-height:21px;">     </span>再尝试<span style="line-height:1.5;">OpenerDirector._call_chain(...): request.get_type()</span>本身的请求类型，函数名为："<span style="line-height:1.5;">http_open"</span><span style="line-height:1.5;">。</span><span style="line-height:1.5;">返回</span><span style="line-height:1.5;">response</span></div><div><span style="line-height:1.5;">            </span><span style="line-height:1.5;">最后尝试</span><span style="line-height:1.5;">OpenerDirector._call_chain(...): </span><span style="line-height:1.5;">请求类型为</span><span style="line-height:1.5;">"unknown"，</span>函数名为"<span style="line-height:21px;"><strong>unknown_open</strong></span>"。返回<span style="line-height:1.5;">response</span></div><div><span style="line-height:1.5;"><br /></span></div><div><span style="line-height:21px;">        # 处理response</span></div><div><span style="line-height:21px;">        </span><span style="line-height:21px;">获取</span><span style="line-height:1.5;">OpenerDirector.handle_open</span>中<span style="line-height:21px;">http的类列表(handlers)，依次执行</span><span style="line-height:1.5;">handler.<span style="line-height:1.5;">http</span>_response<span style="line-height:1.5;">(request)</span></span><span style="line-height:21px;">获取<strong>response</strong></span><span style="line-height:21px;">.(其实列表里面只有一个handler)</span></div><div><span style="line-height:21px;">        End: open(). return <strong>response</strong></span></div><div>"""</div><div>&gt;&gt;&gt; <span style="color:#05FF2A;line-height:21px;">import urllib2 as url</span></div><div>&gt;&gt;&gt; url</div><div>&gt;&gt;&gt; dir(url)</div><div>['AbstractBasicAuthHandler', 'AbstractDigestAuthHandler', 'AbstractHTTPHandler', 'BaseHandler', 'CacheFTPHandler', 'FTPHandler', 'FileHandler', 'HTTPBasicAuthHandler', 'HTTPCookieProcessor', 'HTTPDefaultErrorHandler', 'HTTPDigestAuthHandler', 'HTTPError', 'HTTPErrorProcessor', 'HTTPHandler', 'HTTPPasswordMgr', 'HTTPPasswordMgrWithDefaultRealm', 'HTTPRedirectHandler', 'HTTPSHandler', 'OpenerDirector', 'ProxyBasicAuthHandler', 'ProxyDigestAuthHandler', 'ProxyHandler', 'Request', 'StringIO', 'URLError', 'UnknownHandler', '__builtins__', '__doc__', '__file__', '__name__', '__package__', '__version__', '_cut_port_re', '_opener', '_parse_proxy', '_safe_gethostbyname', 'addinfourl', 'base64', 'bisect', 'build_opener', 'ftpwrapper', 'getproxies', 'hashlib', 'httplib', 'install_opener', 'localhost', 'mimetools', 'os', 'parse_http_list', 'parse_keqv_list', 'posixpath', 'proxy_bypass', 'quote', 'random', 'randombytes', 're', 'request_host', 'socket', 'splitattr', 'splithost', 'splitpasswd', 'splitport', 'splittag', 'splittype', 'splituser', 'splitvalue', 'sys', 'time', 'unquote', 'unwrap', 'url2pathname', 'urlopen', 'urlparse']</div><div>&gt;&gt;&gt; url._opener</div><div>&gt;&gt;&gt; url.build_opener</div><div>&gt;&gt;&gt; <span style="color:#25FF00;line-height:21px;">opener = url.build_opener()</span></div><div>&gt;&gt;&gt; opener</div><div>&gt;&gt;&gt; dir(opener)</div><div>['__doc__', '__init__', '__module__', '_call_chain', '_open', 'add_handler', 'addheaders', 'close', 'error', 'handle_error', 'handle_open', 'handlers', 'open', 'process_request', 'process_response']</div><div>&gt;&gt;&gt; opener.handle_open</div><div>{'unknown': [], 'http': [], 'https': [], 'file': [], 'ftp': []}</div><div>&gt;&gt;&gt; opener.handle_open['http']</div><div>[]</div><div>&gt;&gt;&gt; dir(opener.handle_open['http'][0])</div><div>['__doc__', '__init__', '__lt__', '__module__', '_debuglevel', 'add_parent', 'close', 'do_open', 'do_request_', 'handler_order', 'http_open', 'http_request', 'parent', 'set_http_debuglevel']</div><div>&gt;&gt;&gt;</div><div>&gt;&gt;&gt; opener.handle_open['http'][0].set_http_debuglevel</div><div>&gt;</div><div>&gt;&gt;&gt; opener.handle_open['https'][0].set_http_debuglevel</div><div>&gt;</div><div>&gt;&gt;&gt; <span style="color:#06FF16;line-height:21px;">opener.handle_open['https'][0].set_http_debuglevel(1)</span></div><div>&gt;&gt;&gt; <span style="color:#00FD17;line-height:21px;">opener.handle_open['http'][0].set_http_debuglevel(1)</span></div><div>&gt;&gt;&gt;</div><div>&gt;&gt;&gt;</div><div><div># &gt;&gt;&gt; HTTPHandler 一定会存在，HTTPSHandler在httplib支持https时才会创建. 都继承自:AbstractHTTPHandler</div><div># &gt;&gt;&gt;   关键代码是 HTTPHandler.do_open</div><div># &gt;&gt;&gt;   httplib.HTTPConnection.set_debuglevel(level)</div><div># &gt;&gt;&gt;   httplib.HTTPConnection.request(method, url, body=None, headers={})</div><div># &gt;&gt;&gt;       httplib.HTTPConnection._send_request(method, url, body, headers)</div><div># &gt;&gt;&gt;       httplib.HTTPConnection.endheaders(message_body=None)</div><div># &gt;&gt;&gt;       httplib.HTTPConnection._send_output(message_body=None)</div><div># &gt;&gt;&gt;       httplib.HTTPConnection.send(data) # 其实就是body</div><div># &gt;&gt;&gt;           httplib.HTTPConnection.connect() # 创建socket</div><div># &gt;&gt;&gt;               socket.create_connection(address, timeout= , source_address=None)</div><div># &gt;&gt;&gt;               self.sock = socket.create_connection((self.host,self.port), self.timeout, self.source_address)</div><div># &gt;&gt;&gt;           print send body # print 发送的数据包</div><div># &gt;&gt;&gt;           self.sock.sendall(data)</div><div># &gt;&gt;&gt;   httplib.HTTPConnection.getresponse()</div><div># &gt;&gt;&gt;       HTTPResponse(sock, debuglevel=0, strict=0, method=None, buffering=False)</div><div># &gt;&gt;&gt;       response = self.response_class(*args, **kwds) response_class就是: HTTPResponse</div><div># &gt;&gt;&gt;       HTTPResponse.begin()</div><div># &gt;&gt;&gt;           HTTPResponse._read_status()</div><div># &gt;&gt;&gt;               print "reply:", repr(line) # print 接受到的数据 'HTTP/1.1 200 OK\r\n'</div><div># &gt;&gt;&gt;               return (version, status, reason) # Ex: (HTTP/1.0, 200, OK)</div><div># &gt;&gt;&gt;           如果status == 101:</div><div># &gt;&gt;&gt;               While True:</div><div># &gt;&gt;&gt;                   print "header:", skip # print 接收到的头信息</div><div># &gt;&gt;&gt;           msg = HTTPMessage(self.fp, 0)</div><div># &gt;&gt;&gt;           for hdr in HTTPMessage.headers:</div><div># &gt;&gt;&gt;               print "header:", hdr,</div><div># &gt;&gt;&gt;           HTTPMessage._check_close() #检查头信息：connection是否关闭</div><div># &gt;&gt;&gt;       httplib.HTTPConnection.close()</div><div># &gt;&gt;&gt;           self.sock.close()</div><div># &gt;&gt;&gt;           HTTPResponse.close()</div></div><div><br /></div><div><br /></div><div># &gt;&gt;&gt; opener.handle_open['file'][0].set_http_debuglevel</div><div># Traceback (most recent call last):</div><div>#   File "", line 1, in</div><div># AttributeError: FileHandler instance has no attribute 'set_http_debuglevel'</div><div># &gt;&gt;&gt; opener.handle_open['ftp'][0].set_http_debuglevel</div><div># Traceback (most recent call last):</div><div>#   File "", line 1, in</div><div># AttributeError: FTPHandler instance has no attribute 'set_http_debuglevel'</div><div># &gt;&gt;&gt; opener.handle_open['ftp'][0].set_http_debuglevel(1)</div><div># Traceback (most recent call last):</div><div>#   File "", line 1, in</div><div># AttributeError: FTPHandler instance has no attribute 'set_http_debuglevel'</div><div><br /></div><div>&gt;&gt;&gt; <span style="color:#02FD0A;line-height:21px;">url.install_opener(opener)</span></div><div>&gt;&gt;&gt; <span style="color:#06FF15;line-height:21px;">url.urlopen("http://www.baidu.com")</span></div><div>send: 'GET / HTTP/1.1\r\nAccept-Encoding: identity\r\nHost: www.baidu.com\r\nConnection: close\r\nUser-Agent: Python-urllib/2.7\r\n\r\n'</div><div>reply: 'HTTP/1.1 200 OK\r\n'</div><div>header: Date: Wed, 12 Aug 2015 05:40:47 GMT</div><div>header: Content-Type: text/html; charset=utf-8</div><div>header: Transfer-Encoding: chunked</div><div>header: Connection: Close</div><div>header: Vary: Accept-Encoding</div><div>header: Set-Cookie: BAIDUID=8E25E0CC918EE71717BE5AA3D3472F62:FG=1; expires=Thu, 31-Dec-37 23:55:55 GMT; max-age=2147483647; path=/; domain=.baidu.com</div><div>header: Set-Cookie: BIDUPSID=8E25E0CC918EE71717BE5AA3D3472F62; expires=Thu, 31-Dec-37 23:55:55 GMT; max-age=2147483647; path=/; domain=.baidu.com</div><div>header: Set-Cookie: PSTM=1439358047; expires=Thu, 31-Dec-37 23:55:55 GMT; max-age=2147483647; path=/; domain=.baidu.com</div><div>header: Set-Cookie: BDSVRTM=0; path=/</div><div>header: Set-Cookie: BD_HOME=0; path=/</div><div>header: Set-Cookie: H_PS_PSSID=16229_16415_1431_13520_12825_14429_12868_16520_16799_16331_16662_16427_16514_15243_11854_13932_16720; path=/; domain=.baidu.com</div><div>header: P3P: CP=" OTI DSP COR IVA OUR IND COM "</div><div>header: Cache-Control: private</div><div>header: Cxy_all: baidu+ac7f221e1b28f124d4a8cbfc52852314</div><div>header: Expires: Wed, 12 Aug 2015 05:40:46 GMT</div><div>header: X-Powered-By: HPHP</div><div>header: Server: BWS/1.1</div><div>header: X-UA-Compatible: IE=Edge,chrome=1</div><div>header: BDPAGETYPE: 1</div><div>header: BDQID: 0xdc7ecbce0008572d</div><div>header: BDUSERID: 0</div><div>&gt;</div><div>&gt;&gt;&gt;</div></div><div><div></div></div></div>