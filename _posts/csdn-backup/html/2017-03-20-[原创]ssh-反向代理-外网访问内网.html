---
layout: post
title: "[原创]ssh-反向代理-外网访问内网"
date: 2017-03-20 14:48:05
image: '/assets/img/'
description: ""
tags:
    - 
categories:
    - linux
---



<div id="sina_keyword_ad_area2" class="articalContent newfont_family"><div></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">先明确一下概念</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">    外网是有固定ip的机器，ssh可以之间连接上；</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">    内网是类似公司局域网之类，有独立ip但是不能ssh，需要管理员做端口转发等等权限性操作才可以。</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">文中用内网表示需要被访问的局域网内电脑，用外网表示局域网外电脑。</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><strong># 一、首先，查看外网现有的ssh端口开放情况。</strong></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">[zhipeng@zhangzhipeng2023.cn ~]$<strong><span style="color:#FF0000;line-height:21px;">sudo netstat -anopl | grep ssh</span></strong></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">[sudo] password for zhipeng:</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      22645/sshd           off (0.00/0/0)</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;">-------------------------------------------------------------------</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;"><br /></span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">内网ssh连接外网：</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><div style="line-height:21px;"><span style="line-height:21px;"><strong>ssh -C -R （</strong></span><span style="line-height:1.5;"><span style="line-height:21px;">vpsPort </span></span><strong>）:（</strong><span style="line-height:1.5;"><span style="line-height:21px;">vpsHostname </span></span><strong>）: （</strong><span style="line-height:1.5;">mySSHPort </span><strong>）-p（</strong><span style="line-height:1.5;">vpsSSHPort </span><strong>） （</strong><span style="line-height:1.5;">vpsUser </span><strong>）@（</strong><span style="line-height:1.5;">vpsIP </span><strong>）</strong></div><div style="line-height:21px;">参数说明： </div><div style="line-height:21px;"><em>-C 数据压缩；</em></div><div style="line-height:21px;"><em>-R <span style="line-height:21px;">vpsPort </span>要绑定的外网端口；</em></div><div style="line-height:21px;"><em><span style="line-height:21px;">vpsHostname 给</span>外网设置主机名；</em></div><div style="line-height:21px;"><span style="line-height:21px;"><em>mySSHPort 内网ssh服务的端口。</em></span></div><div style="line-height:21px;"><span style="line-height:21px;"><em>-p vpsSSHPort 外网ssh服务端口</em></span></div><div style="line-height:21px;"><span style="line-height:21px;"><em>vpsUser 外网用户名</em></span></div><div style="line-height:21px;"><span style="line-height:21px;"><em>vpsIP 外网用户名</em></span></div></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);line-height:21px;"><span style="line-height:21px;"><br /></span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><div>neiwang@ZHIPENG-PC ~ $ <span style="line-height:1.5;"><span style="color:#FF0000;line-height:21px;">ssh -C -R 3345:localhost:22 -p 22 zhipeng@<u><em>VPSIP</em></u></span></span></div><div><span style="line-height:1.5;"><br /></span></div><div>Last login: Tue Jun  9 13:12:51 2015 from <strong><u><em>NeiWangIP</em></u></strong></div><div>Welcome to WaiWang Compute Service!</div><div># OK，成功登陆到外网服务器上</div><div><br /></div><div><strong># 二、现在再查看一下外网的SSH端口状态</strong></div><div>可以看到，外网已经在监听3344端口，并且和内网电脑建立了ssh连接</div><div>[zhipeng@zhangzhipeng2023.cn ~]$<span style="color:#FF0000;line-height:21px;"><strong>sudo netstat -anopl | grep ssh</strong></span></div><div>[sudo] password for zhipeng:</div><div><strong>tcp        0      0 <span style="color:#FF0000;line-height:21px;">127.0.0.1:3345</span>          0.0.0.0:*               LISTEN      22799/sshd: zhipeng  off (0.00/0/0)</strong></div><div>tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      22645/sshd           off (0.00/0/0)</div><div><span style="line-height:1.5;">tcp        0     36 <u><em>VPSIP</em></u>:22       <u><em>NeiWangIP</em></u>:11694      ESTABLISHED 22796/sshd: zhipeng  on (0.38/0/0)</span></div><div><br /></div></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><strong># 三、 接着，试一下从外网ssh内网</strong></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;"><strong>$ssh -C  -N -D（</strong></span><span style="line-height:1.5;"><span style="line-height:21px;">vpsPort </span></span><strong>） -p（</strong><em>mySSHPort </em><span style="line-height:1.5;">） （</span><span style="line-height:1.5;">myHostname </span><span style="line-height:1.5;">）@（</span><span style="line-height:1.5;"><span style="line-height:21px;">vpsHostname </span></span><span style="line-height:1.5;">）</span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><span style="line-height:21px;"><strong>参数我就不解释了，看名字和第一步对比就知道了 myName是内网用户名</strong></span></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><strong>我这里加-f -N 是会报错的，如下：</strong></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><div>[zhipeng@zhangzhipeng2023.cn ~]$<strong>ssh -C  <span style="color:#FF0000;line-height:21px;">-f -N</span> -D 3345 -p 3345 neiwang@localhost</strong></div><div>The authenticity of host '[localhost]:3345 ([127.0.0.1]:3345)' can't be established.</div><div>ECDSA key fingerprint is 93:e8:a5:fa:1a:3e:0e:19:6e:c3:28:af:f7:9d:15:3c.</div><div>Are you sure you want to continue connecting (yes/no)? yes</div><div>Warning: Permanently added '[localhost]:3345' (ECDSA) to the list of known hosts.</div><div>neiwang@localhost's password:</div><div>bind: Cannot assign requested address</div><div>channel_setup_fwd_listener: cannot listen to port: 3345</div><div>Could not request local forwarding.</div></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><div>[zhipeng@zhangzhipeng2023.cn ~]$<strong><span style="color:#FF0000;line-height:21px;">sudo ssh -C -D 3345 -p 3345 neiwang@localhost</span></strong></div><div>neiwang@localhost's password: #输入内网密码</div><div>bind: Cannot assign requested address</div><div>channel_setup_fwd_listener: cannot listen to port: 3345</div><div>Could not request local forwarding.</div><div>Last login: Tue Jun  9 13:18:53 2015 from 127.0.0.1</div></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><div><br /></div><div><div>[2015-06-09 13:21.51]  ~</div><div>[neiwang.neiwang-PC] 0bB logout</div><div>Connection to localhost closed.</div></div></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">ssh反向代理大功告成。</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);"><br /></div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">题外话，也不能全算题外话，很重要的</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">0、安全问题，慎用。</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">1、别忘了打开内网的sshd服务</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">2、外网iptables记得打开端口（防火墙）</div><div style="color:rgb(192,189,187);font-family:'Microsoft YaHei', 'Helvetica Neue', SimSun;font-size:14px;text-align:left;background-color:rgb(0,0,0);">3、如果内网电脑是windows，记得关闭防火墙，或者设置好端口访问，不然ssh 22端口会访问异常无法连接。</div><div></div></div>